\section{طراحی و پیاده‌سازی سخت‌افزار}

اصلی‌ترین قسمت این پروژه، طراحی و پیاده‌سازی قسمت‌های سخت‌افزاری آن است. در زیر لیستی از قطعات سخت‌افزاری مورد استفاده آمده است و پس‌ از آن توضیحاتی در مورد هر یک از سنسور‌ها و نحوه کارکرد و راه‌اندازی آن ذکر شده است.


\begin{itemize}
	\item برد \lr{Raspberry Pi 4}
	\item برد \lr{Arduino UNO}
	\item صفحه نمایش لمسی ۷ اینچ مخصوص \lr{Raspberry Pi}
	\item سنسور آلودگی هوا \lr{MQ135}
	\item سنسور دما و رطوبت هوا \lr{DHT11}
	\item سنسور ضربان قلب و اکسیژن‌ خون \lr{Max30102}
	\item سنسور دمای بدن \lr{Max30205}
	\item سنسور نوار قلب \lr{AD8232}
	\item فشار سنج و گوشی پزشکی
\end{itemize}


\subsection{سنسورهای محیطی}

د, سنسور محیطی اصلی در این پروژه وجود دارند. سنسور \lr{MQ135} که وظیفه اندازه‌گیری آلودگی هوا را داشته و سنسور \lr{DHT11} که وظیفه اندازه‌گیری دما و رطوبت را دارد. سنسور آلودگی‌هوا به آردوینو متصل شده و سنسور اندازه‌گیری دما و رطوبت هوا مستقیما به رزبری‌پای متصل می‌شود.


\subsubsection{سنسور دما و رطوبت‌هوا}

سنسور مورد استفاده برای این بخش، \lr{DHT11} است که از قابلیت انتقال داده به صورت دیجیتال پشتیبانی کرده و برای همین به راحتی مطابق شکل \ref{fig:2} به رزبری‌پای متصل می‌شود.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{figs/dht11.jpg}
	
	\caption{اتصال سنسور DHT11}
	\label{fig:2}
\end{figure}


برای خواندن مقادیر از کتاب‌خانه‌ی \lr{Adafruit-Blinka}
\footnote{\lr{https://pypi.org/project/Adafruit-Blinka/}}
استفاده شده است. این کتاب‌خانه با مشخص کردن پین متصل به سنسور، به راحتی امکان خواندن دما و رطوبت هوا را به ما می‌دهد.

کد اصلی مربوط به این قسمت در زیر آورده شده است:

\begin{latin}
\begin{lstlisting}[language=python]
dht11_sensor = adafruit_dht.DHT11(board.D23)
temp = dht11_sensor.temperature
humidity = dht11_sensor.humidity

\end{lstlisting}
\end{latin}

\subsubsection{سنسور آلودگی‌هوا}

با توجه به این که  سنسور \lr{MQ135} خروجی اصلی خود را به صورت آنالوگ تحویل داده و حتی رابط I2C هم ندارد، آن را به برد آردوینو متصل کرده و از طریق اتصال رزبری‌پای به آردوینو با پورت USB، کد مربوط به آن را از طریق رزبری به برد آردوینو انتقال داده و داده‌های لازم را دریافت می‌کنیم.

نحوه اتصال این سنسور در کنار سنسور قبلی در شکل \ref{fig:3} قرار دارد.

\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.3\textwidth]{figs/dhtmq2.jpg}
	
	\caption{اتصال سنسور MQ135}
	\label{fig:3}
\end{figure}



کد اصلی مربوط به این قسمت در زیر آمده است:


در کد آردویینو، مقادیر مربوط به این سنسور هر ۵ ثانیه خوانده می‌شود:
\begin{latin}
	\begin{lstlisting}[language=python]
#include <Wire.h>

void setup() {
	Serial.begin(9600);
	Wire.begin();
}
int counter = 0; // 1 milisecond

void loop() {	
	if (counter % 5000 == 0) // 5 second
	{
		int pollution = analogRead(A0);
		Serial.print("pollution,");
		Serial.println(pollution);
	} 
	counter += 10;
	delay(10);
}
	\end{lstlisting}
\end{latin}

سپس در کد پایتون روی رزبری، این مقادیر روی یک فایل ریخته می‌شود و پس از آن به همراه مقادیر باقی سنسورها به سرور ارسال می‌گردد.




\subsection{سنسورهای بدن}

سه سنسور اصلی برای علائم مربوط به بدن انسان در این پروژه وجود دارند. سنسور دمای بدن \lr{Max30205}، سنسور  ضربان قلب و اکسیژن خون \lr{Max30102} و سنسور نوار قلب یعنی \lr{AD8232}. سنسور \lr{Max30102} مستقیما به رزبری‌پای متصل می‌شود ولی دو سنسور دیگر از طریق آردوینو با رزبری‌پای ارتباط برقرار می‌کنند.


\subsubsection{سنسور دمای بدن}



برای سنجش دمای بدن از سنسور \lr{Max30205} استفاده شده است. با تماس انگشت به آن، بعد از مدتی دمای سنسور با دمای انگشت همدما شده و دمای بدن را نشان خواهد داد. در صورت عدم تماس هم می‌توان از آن برای مشاهده دمای محیط استفاده کرد.

این سسنور به آردوینو متصل شده و از طریق اتصال آردوینو به رزبری‌پای، اطلاعات آن را مشاهده می‌کنیم. در شکل \ref{fig:4} تصویر اتصال این سنسور قرار دارد.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{figs/max30205.jpg}
	
	\caption{اتصال سنسور Max30205}
	\label{fig:4}
\end{figure}


برای خواندن مقادیر این سنسور از کتاب‌خانه‌ی\lr{Protocentra\_MAX30205}
\footnote{\lr{https://github.com/Protocentral/Protocentral\_MAX30205}}
 استفاده شده که امکان خواندن دمای بدن را از طریق آردویینو می‌دهد.

\begin{latin}
	\begin{lstlisting}[language=python]
#include <Wire.h>
#include "Protocentral_MAX30205.h"
MAX30205 tempSensor;

void setup() {
	Serial.begin(9600);
	Wire.begin();
	
	while(!tempSensor.scanAvailableSensors()){
		Serial.println("Couldn't find the sensor." );
		delay(3000);
	}
}
int counter = 0; // 1 milisecond

void loop() {	
	if (counter % 5000 == 0) // 5 second
	{
		float temp = tempSensor.getTemperature(); 
		Serial.print("temp,");
		Serial.println(temp ,2);
	}
	counter += 10;
	delay(10);
}

\end{lstlisting}
\end{latin}


\subsubsection{سنسور ضربان قلب و اکسیژن خون}


برای این بخش از سنسور \lr{Max30102} استفاده شده است. این سنسور با کمک دو چراغ کوچک قرمز و مادون قرمز، ضربان قلب و درصد اشباع اکسیژن در خون (\lr{SpO2}) را اندازه‌گیری می‌کند. این سنسور بدون مشکل از طریق \lr{I2C} به رزبری‌پای متصل می‌شود. نحوه اتصال این سنسور را در شکل \ref{fig:5} مشاهده می‌کنید.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{figs/max30102.jpg}
	
	\caption{اتصال سنسور Max30102}
	\label{fig:5}
\end{figure}


برای راه‌اندازی این سنسور از کدهای مخزن ‌متن‌باز \lr{doug-burrell/max30102}
\footnote{\lr{https://github.com/doug-burrell/max30102}}
با اندکی تغییرات
 استفاده شده است. این مخزن با خواندن مقادیر سنسورهای قرمز/مادون‌قرمز و پردازش آن‌ها، مقادیر ضربان قلب و اکسیژن خون را به طور دقیق محاسبه می‌کند. کدهای مربوط به این مخزن در فایل‌های \lr{heartrate\_monitor.py}
 و
 \lr{max30102.py}
 و 
 \lr{hrcalc.py}
 قرار دارند.
از امکانات این کتاب‌خانه به صورت زیر در کد رزبری استفاده شده است:

\begin{latin}
	\begin{lstlisting}[language=python]
from heartrate_monitor import HeartRateMonitor

hrm = HeartRateMonitor(print_raw=False, print_result=False)
hrm.start_sensor()

bpm = hrm.bpm
spo2 = hrm.spo2

\end{lstlisting}
\end{latin}


	

\subsubsection{سنسور نوار قلب}


از سنسور \lr{AD8232} برای بدست‌ آوردن \lr{ECG} (نوار قلب) استفاده می‌شود. همراه این سنسور بسته \lr{Lead} سه تایی اتصال به بدن وجود دارد. به این \lr{Lead} ها باید پد‌های مخصوص متصل شده و به بدن متصل شوند. برای استفاده از سنسور،‌ آن را به آردوینو متصل می‌کنیم. Lead های‌ آن هم باید مطابق شکل \ref{fig:6} به بدن بیمار متصل بشوند.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.25\textwidth]{figs/ecg.jpg}
	
	\caption{نحوه اتصال Lead‌ های سنسور نوار قلب به بدن}
	\label{fig:6}
\end{figure}



همچنین نحوه اتصال این سنسور به همراه دو سنسور دیگر بدن در شکل \ref{fig:7} قرار دارد.


\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{figs/allbody.jpg}
	
	\caption{اتصال سنسورهای بدن به رزبری‌پای و آردوینو در کنار هم}
	\label{fig:7}
\end{figure}


کدهای آردویینو مربوط به این سنسور در زیر آمده است. هر ۱۰ میلی‌ثانیه مقادیر مربوط به این سنسور از طریق آردویینو خوانده می‌شود.

\begin{latin}
	\begin{lstlisting}[language=python]
#include <Wire.h>
void setup() {
	Serial.begin(9600);
	Wire.begin();
	pinMode(10, INPUT);
	pinMode(11, OUTPUT);
}
int counter = 0; // 1 milisecond
void loop() {
	if (counter % 10 == 0) // 10 milisecond
	{
		Serial.print("ecg,");
		if(digitalRead(10) == 1 || digitalRead(11) == 1) {
		Serial.println('!');
		}
		else {
		int ecg = analogRead(A1);
		Serial.println(ecg);
		}  
	}
	counter += 10;
	delay(10);
}

	\end{lstlisting}
\end{latin}





\subsubsection{انداز‌ه‌گیری فشار خون }

با توجه به این که اندازه‌گیری فشار خون به شکل دقیق معمولا توسط فرد آموزش دیده انجام می‌گیرد و ساخت فشار سنج اتوماتیک از حوزه کاری این محصول خارج بوده و خود یک محصول جداگانه است، فشار در این محصول به شکل انسانی با استفاده از فشارسنج اندازه‌گیری شده و در منویی که برای ثبت فشار در نرم‌افزار قرار گرفته است، وارد می‌شود. تصویر فشارسنج در شکل \ref{fig:12} قرار گرفته است.



\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{figs/cuff.jpg}
	
	\caption{فشارسنج}
	\label{fig:12}
\end{figure}




\subsection{بسته بندی}

برای بسته‌بندی، با توجه به هماهنگی‌های صورت گرفته قرار است که از پرینتر سه‌بعدی استفاده شود. از این رو قسمت بسته‌بندی محصول هنوز کامل نیست. در شکل \ref{fig:9} طرح آماده شده برای بسته‌بندی را مشاهده می‌کنید.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{figs/package.png}
	
	\caption{بسته‌بندی طراحی شده در نرم‌افزار \lr{Tinkercad}}
	\label{fig:9}
\end{figure}

وضعیت فعلی محصول به همراه تمامی سنسور‌ها در شکل \ref{fig:10} آمده است.


\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{figs/all.jpg}
	
	\caption{محصول به همراه تمامی سنسور‌ها }
	\label{fig:10}
\end{figure}

